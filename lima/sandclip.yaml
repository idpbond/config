# Lima template for Sandclip development environment
#
# Usage:
#   limactl create --name=sandclip https://raw.githubusercontent.com/idpbond/config/master/lima/sandclip.yaml
#   limactl start sandclip
#   limactl shell sandclip
#
# The prebuilt qcow2 images from GitHub Releases include all tools already
# installed (Node.js, Docker, Neovim, Claude Code, etc). The provisioning
# scripts below are kept as no-op fallbacks — if the image is already
# provisioned, they exit early.
#
# To override mount paths, edit the `mounts` section or pass --mount flags.

# VM Configuration
vmType: "vz" # Use Apple Virtualization.framework on macOS (faster than QEMU)
arch: null # Auto-detect (aarch64 on Apple Silicon, x86_64 on Intel)

cpus: 4
memory: "8GiB"
disk: "50GiB"

# Prebuilt Sandclip images from GitHub Releases (fall back to base Debian cloud images)
images:
  - location: "https://github.com/idpbond/config/releases/latest/download/sandclip-arm64.qcow2.gz"
    arch: "aarch64"
  - location: "https://github.com/idpbond/config/releases/latest/download/sandclip-amd64.qcow2.gz"
    arch: "x86_64"
  # Fallback: base Debian Trixie cloud images (will need full provisioning)
  - location: "https://cloud.debian.org/images/cloud/trixie/latest/debian-13-genericcloud-arm64.qcow2"
    arch: "aarch64"
  - location: "https://cloud.debian.org/images/cloud/trixie/latest/debian-13-genericcloud-amd64.qcow2"
    arch: "x86_64"

mounts:

# Port forwarding for common development ports
portForwards:
  - guestPortRange: [3000, 3100]
    hostPortRange: [3000, 3100]
  - guestPortRange: [4000, 4100]
    hostPortRange: [4000, 4100]
  - guestPortRange: [5000, 5100]
    hostPortRange: [5000, 5100]
  - guestPortRange: [8000, 9000]
    hostPortRange: [8000, 9000]

# Use custom DNS (disable host resolver)
hostResolver:
  enabled: false
dns:
  - 1.1.1.1
  - 8.8.8.8

# VM options for vz (Virtualization.framework)
# Disable Lima's nerdctl/containerd — the image already has Docker
containerd:
  system: false
  user: false

vmOpts:
  vz:
    rosetta:
      enabled: true
      binfmt: true

# Provisioning scripts — only run if the image was not prebuilt
provision:
  # Fix MTU for virtualized network (prevents TLS hangs)
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      PRIMARY_IF=$(ip route | grep default | awk '{print $5}' | head -1)
      if [ -n "$PRIMARY_IF" ]; then
        ip link set "$PRIMARY_IF" mtu 1400
      fi

  # Remove containerd 2.x binaries from cloud image (conflict with Debian-packaged 1.7.x)
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      rm -f /usr/local/bin/containerd*

  # Download and run setup script (skips if already provisioned)
  - mode: system
    script: |
      #!/bin/bash
      set -eux -o pipefail
      # Skip if the image was already provisioned by Packer
      if id human &>/dev/null && command -v nvim &>/dev/null; then
        echo "Image already provisioned, skipping setup-env.sh"
        exit 0
      fi
      cd /tmp
      curl -fsSL https://raw.githubusercontent.com/idpbond/config/refs/heads/master/setup-env.sh -o setup-env.sh
      chmod +x setup-env.sh
      TARGET_USER="{{.User}}" NONINTERACTIVE=1 ./setup-env.sh

# Message displayed after VM is ready
message: |
  Sandclip development environment is ready!

  To access:
    limactl shell {{.Name}}

  Installed tools:
    - Node.js (via asdf)
    - Docker (rootful, sudo-less)
    - Claude Code CLI
    - Neovim, tmux, fzf, ripgrep, lazygit

  Home directory is mounted read-write.
